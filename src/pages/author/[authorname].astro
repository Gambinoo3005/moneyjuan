---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import FormattedDate from '../../components/FormattedDate.astro';
import Layout from '../../layouts/Layout.astro';
import { SITE_TITLE } from '../../consts';
import { AUTHORS, getAuthorBySlug } from '../../data/authors';

export async function getStaticPaths() {
	return AUTHORS.map((author) => ({
		params: { authorname: author.slug },
		props: { authorSlug: author.slug },
	}));
}

const { authorSlug } = Astro.props as { authorSlug: string };
const author = getAuthorBySlug(authorSlug);

if (!author) {
	throw new Error(`Author not found for slug: ${authorSlug}`);
}

const authorPosts = (await getCollection('blog'))
	.filter((post) => (post.data.author || '').trim().toLowerCase() === author.name.toLowerCase())
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const toTitleCase = (value: string) =>
	value
		.split('-')
		.map((part) => part.charAt(0).toUpperCase() + part.slice(1))
		.join(' ');

const authorUrl = new URL(`/author/${author.slug}/`, Astro.site).toString();
const sameAs = [author.links?.linkedin, author.links?.website].filter(
	(link): link is string => Boolean(link),
);
const knowsAbout = Array.from(
	new Set(
		authorPosts
			.map((post) => post.data.category)
			.filter((category): category is string => Boolean(category))
			.map((category) => toTitleCase(category)),
	),
);

const authorStructuredData = JSON.parse(
	JSON.stringify({
		'@context': 'https://schema.org',
		'@type': 'ProfilePage',
		url: authorUrl,
		name: `${author.name} | ${SITE_TITLE}`,
		description: author.bio,
		mainEntity: {
			'@type': 'Person',
			'@id': `${authorUrl}#author`,
			name: author.name,
			description: author.bio,
			url: authorUrl,
			image: new URL(author.image, Astro.site).toString(),
			jobTitle: author.role,
			email: author.links?.email ? `mailto:${author.links.email}` : undefined,
			sameAs: sameAs.length > 0 ? sameAs : undefined,
			knowsAbout: knowsAbout.length > 0 ? knowsAbout : undefined,
			worksFor: {
				'@type': 'Organization',
				name: SITE_TITLE,
				url: new URL('/', Astro.site).toString(),
			},
		},
	}),
);
---

<Layout title={`${author.name} | MoneyJuan`} description={author.bio} structuredData={authorStructuredData}>
	<div class="container author-page">
		<section class="profile-card">
			<div class="profile-image-wrap">
				<img src={author.image} alt={author.name} class="profile-image" loading="eager" />
			</div>
			<div class="profile-content">
				<p class="profile-eyebrow">Author</p>
				<h1 class="profile-name">{author.name}</h1>
				<p class="profile-role">{author.role}</p>
				<p class="profile-bio">{author.bio}</p>
				{author.links && (
					<div class="profile-social" aria-label={`${author.name} links`}>
						{author.links.linkedin && (
							<a
								href={author.links.linkedin}
								target="_blank"
								rel="noopener noreferrer"
								class="profile-social-link"
								aria-label="LinkedIn"
								title="LinkedIn"
							>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
									<path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
								</svg>
							</a>
						)}
						{author.links.website && (
							<a
								href={author.links.website}
								target="_blank"
								rel="noopener noreferrer"
								class="profile-social-link"
								aria-label="Website"
								title="Website"
							>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
									<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
									<path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
								</svg>
							</a>
						)}
						{author.links.email && (
							<a
								href={`mailto:${author.links.email}`}
								class="profile-social-link"
								aria-label="Email"
								title={author.links.email}
							>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
									<path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"></path>
									<polyline points="22,6 12,13 2,6"></polyline>
								</svg>
							</a>
						)}
					</div>
				)}
			</div>
		</section>

		<section class="posts-section">
			<h2 class="posts-title">Articles by {author.name}</h2>
			{authorPosts.length === 0 ? (
				<p class="no-posts">No published articles yet.</p>
			) : (
				<div class="grid posts-grid">
					{authorPosts.map((post) => (
						<a href={`/blog/${post.id}/`} class="card post-card">
							<div class="image-container">
								{post.data.heroImage && <Image width={720} height={360} src={post.data.heroImage} alt="" />}
							</div>
							<div class="post-content">
								<div class="category-small">{post.data.category ? post.data.category.replace('-', ' ') : 'Article'}</div>
								<h3 class="title">{post.data.title}</h3>
								<div class="meta-small">
									<FormattedDate date={post.data.pubDate} />
								</div>
							</div>
						</a>
					))}
				</div>
			)}
		</section>
	</div>
</Layout>

<style>
	.author-page {
		padding-top: var(--space-md);
		padding-bottom: var(--space-lg);
		max-width: 980px;
	}

	.profile-card {
		display: grid;
		grid-template-columns: 220px 1fr;
		gap: var(--space-md);
	}

	.profile-image-wrap {
		align-self: start;
	}

	.profile-image {
		width: 100%;
		aspect-ratio: 1 / 1;
		object-fit: cover;
		border-radius: 14px;
		border: 1px solid var(--color-border);
	}

	.profile-eyebrow {
		font-size: 0.8rem;
		text-transform: uppercase;
		letter-spacing: 0.08em;
		font-weight: 700;
		color: var(--color-primary);
		margin-bottom: 0.25rem;
	}

	.profile-name {
		font-size: clamp(1.9rem, 4vw, 2.5rem);
		font-weight: 800;
		line-height: 1.15;
		margin-bottom: 0.35rem;
	}

	.profile-role {
		font-size: 1rem;
		font-weight: 700;
		color: var(--color-text-muted);
		margin-bottom: 0.8rem;
	}

	.profile-bio {
		font-size: 1rem;
		line-height: 1.7;
		color: var(--color-text-main);
		max-width: 75ch;
	}

	.profile-social {
		margin-top: var(--space-sm);
		display: flex;
		align-items: center;
		gap: 0.85rem;
	}

	.profile-social-link {
		width: 36px;
		height: 36px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		border: 1px solid var(--color-border);
		background: transparent;
		color: var(--color-text-main);
		cursor: pointer;
		transition: all 0.2s ease;
		text-decoration: none;
	}

	.profile-social-link:hover {
		color: var(--color-primary);
		border-color: var(--color-primary);
		background: var(--color-surface);
		transform: translateY(-2px);
	}

	.profile-social-link svg {
		width: 18px;
		height: 18px;
	}

	.posts-section {
		margin-top: var(--space-md);
	}

	.posts-title {
		font-size: clamp(1.4rem, 3vw, 2rem);
		margin-bottom: var(--space-sm);
	}

	.no-posts {
		color: var(--color-text-muted);
	}

	.posts-grid {
		grid-template-columns: repeat(auto-fill, minmax(min(250px, 100%), 1fr));
		gap: var(--space-md);
	}

	.post-card {
		background: #FFFFFF;
		border-radius: 12px;
		border: 1px solid var(--color-border);
		overflow: hidden;
		transition: all 0.3s ease;
		text-decoration: none;
		display: flex;
		flex-direction: column;
		color: inherit;
	}

	.post-card:hover {
		box-shadow: var(--shadow-md);
		border-color: var(--color-primary);
	}

	.image-container {
		width: 100%;
		aspect-ratio: 16 / 9;
		overflow: hidden;
		background: var(--color-surface);
		border-bottom: 1px solid var(--color-border);
	}

	.post-card:hover .image-container {
		border-bottom-color: var(--color-primary);
	}

	.image-container img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.3s ease;
	}

	.post-content {
		padding: var(--space-sm);
		display: flex;
		flex-direction: column;
		flex: 1;
	}

	.category-small {
		font-size: 0.75rem;
		font-weight: 700;
		text-transform: uppercase;
		color: var(--color-primary);
		margin-bottom: 0.3rem;
		letter-spacing: 0.05em;
	}

	.title {
		font-size: 1.15rem;
		line-height: 1.35;
		margin-bottom: var(--space-xs);
	}

	.meta-small {
		font-size: 0.85rem;
		color: var(--color-text-muted);
		margin-top: auto;
	}

	@media (max-width: 800px) {
		.profile-card {
			grid-template-columns: 1fr;
			gap: var(--space-sm);
		}

		.profile-image-wrap {
			max-width: 160px;
		}
	}
</style>
