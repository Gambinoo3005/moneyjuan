---
import BlogPost from '../../layouts/BlogPost.astro';
import { getPostBySlug, getRelatedPosts } from '../../lib/sanity/api';
import { getPortableTextHeadings } from '../../lib/sanity/portableText';

export const prerender = false;

const slugParam = Astro.params.slug;
const slug = Array.isArray(slugParam) ? slugParam.join('/') : slugParam;

if (!slug) {
	return Astro.redirect('/blog/');
}

const post = await getPostBySlug(slug);

if (!post) {
	return Astro.redirect('/404');
}

const relatedPosts = post.category ? await getRelatedPosts(post.category, post.id) : [];
const headings = getPortableTextHeadings(post.body);
---

<BlogPost {...post} headings={headings} relatedPosts={relatedPosts} />
