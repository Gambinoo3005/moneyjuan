---
// src/components/calculator/BonusCalculator.astro
---

<div class="calculator-module hidden" id="bonus-calculator">
    <div class="input-group">
        <label for="bonus-basic-pay">Monthly Basic Pay</label>
        <div class="input-wrapper">
            <span class="currency">₱</span>
            <input
                type="text"
                id="bonus-basic-pay"
                placeholder="0.00"
                class="formatted-input"
            />
        </div>
    </div>

    <div class="input-group">
        <label for="months-worked">Months Worked in Year</label>
        <input
            type="number"
            id="months-worked"
            placeholder="12"
            min="1"
            max="12"
            value="12"
        />
    </div>

    <div class="input-group">
        <label for="other-bonuses">Other Bonuses Received (YTD)</label>
        <div class="input-wrapper">
            <span class="currency">₱</span>
            <input
                type="text"
                id="other-bonuses"
                placeholder="0.00"
                class="formatted-input"
            />
        </div>
        <small class="hint"
            >Includes performance bonus, etc. Used to check ₱90k exemption.</small
        >
    </div>

    <button id="calc-bonus-btn" class="btn-primary">Calculate 13th Month</button
    >

    <div id="bonus-result" class="result-section hidden">
        <h3>13th Month Pay Estimation</h3>

        <div class="result-card">
            <div class="net-pay-label">13th Month Pay Amount</div>
            <div class="net-pay-display">
                <span class="currency">₱</span>
                <span id="bonus-amount-result">0.00</span>
            </div>
        </div>

        <div class="result-breakdown">
            <div class="breakdown-item">
                <span>Total Bonuses (13th + Other)</span>
                <span id="total-bonus-result">0.00</span>
            </div>
            <div class="breakdown-item success">
                <span>Tax-Exempt Amount (Max ₱90k)</span>
                <span id="tax-exempt-result">0.00</span>
            </div>
            <div class="breakdown-item warning">
                <span>Taxable Amount (Excess)</span>
                <span id="taxable-bonus-result">0.00</span>
            </div>
        </div>

        <div class="recommendation info">
            Any amount exceeding the ₱90,000 threshold is added to your taxable
            income and subject to income tax.
        </div>

        <div class="export-buttons" data-html2canvas-ignore="true">
            <button id="bonus-save-image-btn" class="btn-secondary">
                <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"
                    ></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                Save as Image
            </button>
            <button id="bonus-save-pdf-btn" class="btn-secondary">
                <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path
                        d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                    ></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Save as PDF
            </button>
        </div>
    </div>
</div>

<style>
    .calculator-module {
        background: #fff;
        padding: var(--space-md);
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        max-width: 600px;
        margin: 0 auto;
    }

    .hidden {
        display: none !important;
    }

    .input-group {
        margin-bottom: var(--space-sm);
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--color-text-main);
        font-size: 0.95rem;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-wrapper .currency {
        position: absolute;
        left: 1.25rem;
        color: var(--color-text-muted);
        font-weight: 500;
        pointer-events: none;
        z-index: 10;
    }

    input[type="text"],
    input[type="number"] {
        width: 100%;
        padding: 0.875rem 0.875rem 0.875rem 2.5rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        font-size: 1rem;
        font-family: var(--font-body);
        color: var(--color-text-main);
        transition: var(--transition-base);
    }

    input[type="number"] {
        padding-left: 1rem;
    }

    input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    .btn-primary {
        width: 100%;
        background-color: var(--color-primary);
        color: white;
        padding: 0.875rem;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: var(--space-sm);
        font-family: var(--font-display);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.95rem;
    }

    .btn-primary:hover {
        background-color: #047857;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .hint {
        font-size: 0.8rem;
        color: var(--color-text-muted);
        margin-top: 0.25rem;
        display: block;
    }

    .result-section {
        margin-top: var(--space-md);
        padding-top: var(--space-md);
        border-top: 1px solid var(--color-border);
        animation: fadeIn 0.5s ease-out;
    }

    .result-section h3 {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-text-muted);
        text-align: center;
        margin-bottom: 1rem;
    }

    .result-card {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        padding: 2rem;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 1.5rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #a7f3d0;
    }

    .net-pay-label {
        font-size: 1rem;
        font-weight: 600;
        color: #065f46;
        margin-bottom: 0.5rem;
    }

    .net-pay-display {
        font-size: 2.5rem;
        font-weight: 800;
        color: #059669;
        font-family: var(--font-display);
        letter-spacing: -0.02em;
    }

    .result-breakdown {
        background: var(--color-surface);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid var(--color-border);
    }

    .breakdown-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px dashed var(--color-border);
        font-size: 0.95rem;
        color: var(--color-text-main);
    }

    .breakdown-item:last-child {
        border-bottom: none;
    }

    .breakdown-item.success {
        color: var(--color-primary);
        font-weight: 600;
    }

    .breakdown-item.warning {
        color: #d97706; /* Amber 600 */
        font-weight: 600;
    }

    .recommendation {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        text-align: center;
    }

    .recommendation.info {
        background: #eff6ff;
        color: #1e40af;
        border: 1px solid #bfdbfe;
    }

    .export-buttons {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        justify-content: center;
    }

    .btn-secondary {
        flex: 1;
        background-color: #fff;
        color: var(--color-primary);
        border: 2px solid var(--color-primary);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: var(--font-body);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-secondary:hover {
        background-color: var(--color-primary);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .btn-secondary svg {
        flex-shrink: 0;
    }
</style>

<!-- Export Libraries -->
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
></script>

<script>
    import { addToHistory } from "../../utils/historyManager";

    const calcBtn = document.getElementById("calc-bonus-btn");
    const saveImageBtn = document.getElementById("bonus-save-image-btn");
    const savePdfBtn = document.getElementById("bonus-save-pdf-btn");
    const resultSection = document.getElementById("bonus-result");

    // Input Formatting
    const formatNumber = (num: string) => {
        if (!num) return "";
        const parts = num.split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    };

    const parseFormattedNumber = (str: string) => {
        return parseFloat(str.replace(/,/g, "")) || 0;
    };

    const formattedInputs = document.querySelectorAll(
        "#bonus-calculator .formatted-input",
    );
    formattedInputs.forEach((input) => {
        const el = input as HTMLInputElement;
        el.addEventListener("input", (e) => {
            const target = e.target as HTMLInputElement;
            const cursorPosition = target.selectionStart || 0;
            const oldValue = target.value;
            let value = target.value.replace(/[^\d.]/g, "");
            const parts = value.split(".");
            if (parts.length > 2)
                value = parts[0] + "." + parts.slice(1).join("");
            if (parts.length === 2 && parts[1].length > 2)
                value = parts[0] + "." + parts[1].substring(0, 2);
            const formatted = formatNumber(value);
            target.value = formatted;
            const addedCommas =
                (formatted.match(/,/g) || []).length -
                (oldValue.match(/,/g) || []).length;
            const newPosition = cursorPosition + addedCommas;
            target.setSelectionRange(newPosition, newPosition);
        });
    });

    if (calcBtn) {
        const runCalculation = (saveToHistory = true) => {
            const getVal = (id: string) => {
                const el = document.getElementById(id) as HTMLInputElement;
                if (el.classList.contains("formatted-input"))
                    return parseFormattedNumber(el.value);
                return parseFloat(el?.value || "0");
            };

            const basicPay = getVal("bonus-basic-pay");
            const monthsWorked =
                parseFloat(
                    (
                        document.getElementById(
                            "months-worked",
                        ) as HTMLInputElement
                    ).value,
                ) || 12;
            const otherBonuses = getVal("other-bonuses");

            // Logic
            const thirteenthMonth = (basicPay * monthsWorked) / 12;
            const totalBonus = thirteenthMonth + otherBonuses;
            const exemptionCap = 90000;
            const taxableBonus = Math.max(0, totalBonus - exemptionCap);
            const exemptAmount = Math.min(exemptionCap, totalBonus);

            // UI
            const fmt = (num: number) =>
                num.toLocaleString("en-PH", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                });
            const setText = (id: string, val: string) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val;
            };

            setText("bonus-amount-result", fmt(thirteenthMonth));
            setText("total-bonus-result", fmt(totalBonus));
            setText("tax-exempt-result", fmt(exemptAmount));
            setText("taxable-bonus-result", fmt(taxableBonus));

            const resultSection = document.getElementById("bonus-result");
            resultSection?.classList.remove("hidden");

            if (saveToHistory) {
                // History
                addToHistory({
                    type: "Bonus",
                    summary: `13th Month: ₱${fmt(thirteenthMonth)}`,
                    result: `Taxable: ₱${fmt(taxableBonus)}`,
                    inputData: { basicPay, monthsWorked, otherBonuses },
                });
            }

            resultSection?.scrollIntoView({
                behavior: "smooth",
                block: "center",
            });
        };

        calcBtn.addEventListener("click", () => runCalculation(true));

        // Listen for Restore
        window.addEventListener("restore-calc", (e: any) => {
            if (e.detail.type !== "Bonus") return;

            // Small delay
            setTimeout(() => {
                const data = e.detail.inputData;

                // Populate fields
                const setVal = (id: string, val: number | string) => {
                    const el = document.getElementById(id) as HTMLInputElement;
                    if (el) {
                        if (el.classList.contains("formatted-input")) {
                            el.value = formatNumber(val.toString());
                        } else {
                            el.value = val.toString();
                        }
                    }
                };

                setVal("bonus-basic-pay", data.basicPay);
                setVal("months-worked", data.monthsWorked);
                setVal("other-bonuses", data.otherBonuses);

                runCalculation(false);
            }, 100);
        });
    }

    // Export Logic with Fixes
    const handleExport = async (type: "image" | "pdf") => {
        if (!resultSection) return;
        try {
            const rootStyles = getComputedStyle(document.documentElement);
            resultSection.style.setProperty(
                "--color-primary",
                rootStyles.getPropertyValue("--color-primary"),
            );
            resultSection.style.setProperty(
                "--color-text-main",
                rootStyles.getPropertyValue("--color-text-main"),
            );
            resultSection.style.setProperty(
                "--color-text-muted",
                rootStyles.getPropertyValue("--color-text-muted"),
            );

            // @ts-ignore
            const canvas = await html2canvas(resultSection, {
                backgroundColor: "#ffffff",
                scale: 2,
                logging: false,
                useCORS: true,
                onclone: (clonedDoc: any) => {
                    const el = clonedDoc.getElementById("bonus-result");
                    if (el) {
                        el.style.animation = "none";
                        el.style.opacity = "1";
                        el.style.transform = "none";
                    }
                },
            });

            if (type === "image") {
                canvas.toBlob((blob: any) => {
                    if (!blob) return;
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.download = `bonus-calculation-${Date.now()}.png`;
                    link.href = url;
                    link.click();
                });
            } else {
                const imgData = canvas.toDataURL("image/png");
                // @ts-ignore
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4",
                });
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
                pdf.save(`bonus-calculation-${Date.now()}.pdf`);
            }
        } catch (e) {
            console.error(e);
            alert("Export failed");
        }
    };

    if (saveImageBtn)
        saveImageBtn.addEventListener("click", () => handleExport("image"));
    if (savePdfBtn)
        savePdfBtn.addEventListener("click", () => handleExport("pdf"));
</script>
