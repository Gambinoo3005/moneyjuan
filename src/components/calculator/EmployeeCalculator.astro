<div class="calculator-module" id="employee-calculator">
  <div class="input-group">
    <label for="pay-period">Pay Period</label>
    <select id="pay-period">
      <option value="monthly" selected>Monthly</option>
      <option value="semi-monthly">Semi-Monthly</option>
      <option value="weekly">Weekly</option>
      <option value="daily">Daily</option>
    </select>
  </div>

  <div class="input-group">
    <label for="basic-pay">Basic Pay (per period)</label>
    <div class="input-wrapper">
      <span class="currency">₱</span>
      <input
        type="text"
        id="basic-pay"
        placeholder="0.00"
        class="formatted-input"
      />
    </div>
  </div>

  <div class="advanced-toggle">
    <button type="button" id="toggle-advanced">Show Advanced Options</button>
  </div>

  <div class="advanced-options hidden" id="advanced-options">
    <div class="input-group">
      <label for="overtime-pay">Overtime Pay</label>
      <div class="input-wrapper">
        <span class="currency">₱</span>
        <input
          type="text"
          id="overtime-pay"
          placeholder="0.00"
          class="formatted-input"
        />
      </div>
    </div>

    <div class="input-group">
      <label for="night-shift-hours">Night Shift Hours</label>
      <div class="input-wrapper">
        <input
          type="number"
          id="night-shift-hours"
          placeholder="0"
          min="0"
          step="1"
        />
      </div>
    </div>

    <div class="input-group">
      <label for="allowances-taxable">Taxable Allowances</label>
      <div class="input-wrapper">
        <span class="currency">₱</span>
        <input
          type="text"
          id="allowances-taxable"
          placeholder="0.00"
          class="formatted-input"
        />
      </div>
    </div>

    <div class="input-group">
      <label for="allowances-nontaxable">Non-Taxable Allowances</label>
      <div class="input-wrapper">
        <span class="currency">₱</span>
        <input
          type="text"
          id="allowances-nontaxable"
          placeholder="0.00"
          class="formatted-input"
        />
      </div>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="is-mwe" />
      <label for="is-mwe">Minimum Wage Earner?</label>
    </div>
  </div>

  <button id="calculate-btn" class="btn-primary">Calculate Net Pay</button>

  <div id="result-section" class="result-section hidden">
    <h3>Estimated Net Pay</h3>
    <div class="net-pay-display">
      <span class="currency">₱</span>
      <span id="net-pay-value">0.00</span>
    </div>

    <div class="breakdown">
      <div class="breakdown-item">
        <span>Gross Pay</span>
        <span id="gross-pay-value">0.00</span>
      </div>
      <div class="breakdown-item" id="night-diff-row" style="display: none;">
        <span>Night Differential</span>
        <span id="night-diff-value">0.00</span>
      </div>
      <div class="breakdown-item deduction">
        <span>SSS Contribution</span>
        <span id="sss-deduction">0.00</span>
      </div>
      <div class="breakdown-item deduction">
        <span>PhilHealth Contribution</span>
        <span id="philhealth-deduction">0.00</span>
      </div>
      <div class="breakdown-item deduction">
        <span>Pag-IBIG Contribution</span>
        <span id="pagibig-deduction">0.00</span>
      </div>
      <div class="breakdown-item deduction">
        <span>Withholding Tax</span>
        <span id="tax-deduction">0.00</span>
      </div>
      <div class="breakdown-item total-deduction">
        <span>Total Deductions</span>
        <span id="total-deduction">0.00</span>
      </div>
    </div>

    <div class="export-buttons" data-html2canvas-ignore="true">
      <button id="save-image-btn" class="btn-secondary">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        Save as Image
      </button>
      <button id="save-pdf-btn" class="btn-secondary">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
          ></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        Save as PDF
      </button>
    </div>
  </div>
</div>

<style>
  .calculator-module {
    background: #fff;
    padding: var(--space-md);
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--color-border);
    max-width: 500px;
    margin: 0 auto;
  }

  .input-group {
    margin-bottom: var(--space-sm);
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--color-text-main);
    font-size: 0.95rem;
  }

  .input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .input-wrapper .currency {
    position: absolute;
    left: 1.25rem;
    color: var(--color-text-muted);
    font-weight: 500;
    pointer-events: none;
    z-index: 10;
  }

  input,
  select {
    width: 100%;
    padding: 0.875rem;
    padding-left: 2.5rem; /* Space for currency symbol */
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 1rem;
    font-family: var(--font-body);
    color: var(--color-text-main);
    transition:
      border-color 0.2s,
      box-shadow 0.2s;
    background: var(--color-bg);
  }

  select {
    padding-left: 0.75rem;
    cursor: pointer;
  }

  input:focus,
  select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
  }

  .btn-primary {
    width: 100%;
    background-color: var(--color-primary);
    color: white;
    padding: 0.875rem;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: var(--space-sm);
    font-family: var(--font-display);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.95rem;
  }

  .btn-primary:hover {
    background-color: #047857;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .advanced-toggle {
    margin-bottom: var(--space-sm);
    text-align: center;
    margin-top: var(--space-sm);
  }

  #toggle-advanced {
    background: none;
    border: none;
    color: var(--color-primary);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background 0.2s;
  }

  #toggle-advanced:hover {
    background: var(--color-surface-hover);
  }

  .hidden {
    display: none;
  }

  .result-section {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
    animation: fadeIn 0.5s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .result-section h3 {
    font-size: 1.1rem;
    color: var(--color-text-muted);
    text-align: center;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .net-pay-display {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--color-primary);
    text-align: center;
    margin-bottom: var(--space-md);
    font-family: var(--font-display);
    letter-spacing: -0.02em;
  }

  .breakdown {
    background: var(--color-surface);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid var(--color-border);
  }

  .breakdown-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
    color: var(--color-text-main);
  }

  .deduction {
    color: #ef4444;
  }

  .total-deduction {
    border-top: 1px dashed var(--color-border);
    padding-top: 0.75rem;
    margin-top: 0.75rem;
    font-weight: 700;
    color: var(--color-text-main);
  }

  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 1rem;
    padding: 0.75rem;
    background: var(--color-surface);
    border-radius: 6px;
    border: 1px solid var(--color-border);
  }

  .checkbox-group input {
    width: 1.25rem;
    height: 1.25rem;
    padding: 0;
    margin: 0;
    cursor: pointer;
    accent-color: var(--color-primary);
  }

  .checkbox-group label {
    margin-bottom: 0;
    cursor: pointer;
    user-select: none;
  }

  .export-buttons {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
    justify-content: center;
  }

  .btn-secondary {
    flex: 1;
    background-color: #fff;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-body);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-secondary:hover {
    background-color: var(--color-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }

  .btn-secondary svg {
    flex-shrink: 0;
  }
</style>

<script>
  import { calculateEmployeeNetPay } from "../../utils/taxCalculator";
  import { addToHistory } from "../../utils/historyManager";

  const calculateBtn = document.getElementById("calculate-btn");
  const advancedToggle = document.getElementById("toggle-advanced");
  const advancedOptions = document.getElementById("advanced-options");

  // Input Formatting Logic
  const formatNumber = (num: string) => {
    if (!num) return "";
    const parts = num.split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return parts.join(".");
  };

  const parseFormattedNumber = (str: string) => {
    return parseFloat(str.replace(/,/g, "")) || 0;
  };

  const formattedInputs = document.querySelectorAll(".formatted-input");
  formattedInputs.forEach((input) => {
    const el = input as HTMLInputElement;

    // Real-time formatting as user types
    el.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement;
      // Get cursor position before formatting
      const cursorPosition = target.selectionStart || 0;
      const oldValue = target.value;

      // Remove all non-digit and non-decimal characters
      let value = target.value.replace(/[^\d.]/g, "");

      // Ensure only one decimal point
      const parts = value.split(".");
      if (parts.length > 2) {
        value = parts[0] + "." + parts.slice(1).join("");
      }

      // Limit to 2 decimal places
      if (parts.length === 2 && parts[1].length > 2) {
        value = parts[0] + "." + parts[1].substring(0, 2);
      }

      // Format with commas
      const formatted = formatNumber(value);
      target.value = formatted;

      // Adjust cursor position after formatting
      const addedCommas =
        (formatted.match(/,/g) || []).length -
        (oldValue.match(/,/g) || []).length;
      const newPosition = cursorPosition + addedCommas;
      target.setSelectionRange(newPosition, newPosition);
    });

    el.addEventListener("focus", () => {
      // Clear placeholder zeros on focus
      if (el.value === "0.00" || el.value === "0") {
        el.value = "";
      }
    });
  });

  if (advancedToggle && advancedOptions) {
    advancedToggle.addEventListener("click", () => {
      advancedOptions.classList.toggle("hidden");
      advancedToggle.textContent = advancedOptions.classList.contains("hidden")
        ? "Show Advanced Options"
        : "Hide Advanced Options";
    });
  }

  if (calculateBtn) {
    const runCalculation = (saveToHistory = true) => {
      const getVal = (id: string) => {
        const el = document.getElementById(id) as HTMLInputElement;
        if (el.classList.contains("formatted-input")) {
          return parseFormattedNumber(el.value);
        }
        return parseFloat(el?.value || "0");
      };

      const input = {
        period: (document.getElementById("pay-period") as HTMLSelectElement)
          .value as any,
        basicPay: getVal("basic-pay"),
        overtimePay: getVal("overtime-pay"),
        nightShiftHours: getVal("night-shift-hours"),
        allowancesTaxable: getVal("allowances-taxable"),
        allowancesNonTaxable: getVal("allowances-nontaxable"),
        bonusThisPay: 0,
        bonusYTDExclThisPay: 0,
        isMinimumWageEarner: (
          document.getElementById("is-mwe") as HTMLInputElement
        ).checked,
      };

      const result = calculateEmployeeNetPay(input);

      // Update UI
      const fmt = (num: number) =>
        num.toLocaleString("en-PH", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });

      const setText = (id: string, val: string) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
      };

      setText("net-pay-value", fmt(result.netPay));
      setText("gross-pay-value", fmt(result.grossPay));
      setText("sss-deduction", `-${fmt(result.deductions.sss)}`);
      setText("philhealth-deduction", `-${fmt(result.deductions.philhealth)}`);
      setText("pagibig-deduction", `-${fmt(result.deductions.pagibig)}`);
      setText("tax-deduction", `-${fmt(result.deductions.tax)}`);
      setText("total-deduction", `-${fmt(result.deductions.total)}`);

      // Show/Hide Night Diff Row
      const ndRow = document.getElementById("night-diff-row");
      if (result.nightDifferentialPay > 0 && ndRow) {
        ndRow.style.display = "flex";
        setText("night-diff-value", fmt(result.nightDifferentialPay));
      } else if (ndRow) {
        ndRow.style.display = "none";
      }

      const resultSection = document.getElementById("result-section");
      resultSection?.classList.remove("hidden");

      if (saveToHistory) {
        addToHistory({
          type: "Employee",
          summary: `Gross: ₱${fmt(result.grossPay)}`,
          result: `Net: ₱${fmt(result.netPay)}`,
          inputData: input,
        });
      }

      // Scroll to result if it was a restore or user click
      resultSection?.scrollIntoView({ behavior: "smooth", block: "center" });
    };

    calculateBtn.addEventListener("click", () => runCalculation(true));

    // Listen for Restore
    window.addEventListener("restore-calc", (e: any) => {
      if (e.detail.type !== "Employee") return;

      // Small delay to ensure the tab has switched and the module is visible
      setTimeout(() => {
        const data = e.detail.inputData;

        // Populate fields
        const setVal = (id: string, val: number | string) => {
          const el = document.getElementById(id) as HTMLInputElement;
          if (el) {
            if (el.classList.contains("formatted-input")) {
              el.value = formatNumber(val.toString());
            } else if (el.type === "checkbox") {
              el.checked = !!val;
            } else {
              el.value = val.toString();
            }
          }
        };

        setVal("pay-period", data.period);
        setVal("basic-pay", data.basicPay);
        setVal("overtime-pay", data.overtimePay);
        setVal("night-shift-hours", data.nightShiftHours);
        setVal("allowances-taxable", data.allowancesTaxable);
        setVal("allowances-nontaxable", data.allowancesNonTaxable);
        setVal("is-mwe", data.isMinimumWageEarner);

        // Run without saving logic
        runCalculation(false);
      }, 100);
    });
  }
</script>

<!-- Export Libraries -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
></script>

<script>
  // Export functionality
  document.addEventListener("DOMContentLoaded", () => {
    const saveImageBtn = document.getElementById("save-image-btn");
    const savePdfBtn = document.getElementById("save-pdf-btn");
    const resultSection = document.getElementById("result-section");

    if (saveImageBtn) {
      saveImageBtn.addEventListener("click", async () => {
        if (!resultSection) return;

        try {
          // Fix for washed out colors: Inline CSS variables
          const rootStyles = getComputedStyle(document.documentElement);
          const primary = rootStyles.getPropertyValue("--color-primary");
          const textMain = rootStyles.getPropertyValue("--color-text-main");
          const textMuted = rootStyles.getPropertyValue("--color-text-muted");
          const border = rootStyles.getPropertyValue("--color-border");
          const surface = rootStyles.getPropertyValue("--color-surface");

          resultSection.style.setProperty("--color-primary", primary);
          resultSection.style.setProperty("--color-text-main", textMain);
          resultSection.style.setProperty("--color-text-muted", textMuted);
          resultSection.style.setProperty("--color-border", border);
          resultSection.style.setProperty("--color-surface", surface);

          // @ts-ignore - html2canvas is loaded via CDN
          const canvas = await html2canvas(resultSection, {
            backgroundColor: "#ffffff",
            scale: 2,
            logging: false,
            useCORS: true,
            onclone: (clonedDoc: any) => {
              const el = clonedDoc.getElementById("result-section");
              if (el) {
                el.style.animation = "none";
                el.style.opacity = "1";
                el.style.transform = "none";
              }
            },
          });

          // Convert to blob and download
          canvas.toBlob((blob: any) => {
            if (!blob) return;
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.download = `employee-tax-calculation-${new Date().getTime()}.png`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
          });
        } catch (error) {
          console.error("Error generating image:", error);
          alert("Failed to generate image. Please try again.");
        }
      });
    }

    if (savePdfBtn) {
      savePdfBtn.addEventListener("click", async () => {
        if (!resultSection) return;

        try {
          // Fix for washed out colors: Inline CSS variables
          const rootStyles = getComputedStyle(document.documentElement);
          const primary = rootStyles.getPropertyValue("--color-primary");
          const textMain = rootStyles.getPropertyValue("--color-text-main");
          const textMuted = rootStyles.getPropertyValue("--color-text-muted");
          const border = rootStyles.getPropertyValue("--color-border");
          const surface = rootStyles.getPropertyValue("--color-surface");

          resultSection.style.setProperty("--color-primary", primary);
          resultSection.style.setProperty("--color-text-main", textMain);
          resultSection.style.setProperty("--color-text-muted", textMuted);
          resultSection.style.setProperty("--color-border", border);
          resultSection.style.setProperty("--color-surface", surface);

          // @ts-ignore - html2canvas and jsPDF are loaded via CDN
          const canvas = await html2canvas(resultSection, {
            backgroundColor: "#ffffff",
            scale: 2,
            logging: false,
            useCORS: true,
            onclone: (clonedDoc: any) => {
              const el = clonedDoc.getElementById("result-section");
              if (el) {
                el.style.animation = "none";
                el.style.opacity = "1";
                el.style.transform = "none";
              }
            },
          });

          const imgData = canvas.toDataURL("image/png");

          // @ts-ignore
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: "portrait",
            unit: "mm",
            format: "a4",
          });

          const imgWidth = 190;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
          pdf.save(`employee-tax-calculation-${new Date().getTime()}.pdf`);
        } catch (error) {
          console.error("Error generating PDF:", error);
          alert("Failed to generate PDF. Please try again.");
        }
      });
    }
  });
</script>

