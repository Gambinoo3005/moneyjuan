<div id="history-container" class="history-container hidden">
    <div class="history-header">
        <h3>
            <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><circle cx="12" cy="12" r="10"></circle><polyline
                    points="12 6 12 12 16 14"></polyline></svg
            >
            Recent History
        </h3>
        <button id="clear-history-btn" class="btn-clear">Clear All</button>
    </div>
    <div id="history-list" class="history-list">
        <!-- JS injected -->
    </div>
</div>

<div id="history-confirm-overlay" class="history-confirm-overlay hidden" aria-hidden="true">
    <div
        id="history-confirm-dialog"
        class="history-confirm-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="history-confirm-title"
        aria-describedby="history-confirm-message"
        tabindex="-1"
    >
        <h4 id="history-confirm-title">Clear History?</h4>
        <p id="history-confirm-message">
            This will permanently remove all saved calculator history.
        </p>
        <div class="history-confirm-actions">
            <button id="history-confirm-cancel" type="button" class="history-confirm-btn history-confirm-btn-cancel">
                Keep History
            </button>
            <button id="history-confirm-accept" type="button" class="history-confirm-btn history-confirm-btn-accept">
                Clear All
            </button>
        </div>
    </div>
</div>

<style>
    .history-container {
        background: #fff;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: var(--space-md);
        margin-top: var(--space-lg);
        box-shadow: var(--shadow-sm);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .history-container.hidden {
        display: none;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--color-border);
    }

    .history-header h3 {
        font-size: 1.1rem;
        color: var(--color-text-main);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .btn-clear {
        background: none;
        border: none;
        color: var(--color-text-muted);
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: underline;
    }

    .btn-clear:hover {
        color: #ef4444;
    }

    .history-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    /* Dynamic Item Styles (Global because injected by JS) */
    :global(.history-item) {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--color-surface);
        border-radius: 8px;
        border-left: 3px solid var(--color-primary);
        cursor: pointer;
        transition:
            transform 0.1s ease,
            background-color 0.2s;
    }

    :global(.history-item:hover) {
        background-color: var(--color-surface-hover);
        transform: translateX(2px);
    }

    :global(.history-info) {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    :global(.history-type) {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--color-text-muted);
        letter-spacing: 0.05em;
    }

    :global(.history-summary) {
        font-size: 0.9rem;
        color: var(--color-text-main);
    }

    :global(.history-result) {
        font-weight: 700;
        color: var(--color-primary);
        font-family: var(--font-display);
    }

    .history-confirm-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        z-index: 1400;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .history-confirm-overlay.hidden {
        display: none;
    }

    .history-confirm-dialog {
        width: min(420px, 100%);
        background: #FFFFFF;
        border: 1px solid var(--color-border);
        border-radius: 14px;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
        padding: 1.1rem;
    }

    .history-confirm-dialog h4 {
        font-family: var(--font-display);
        font-size: 1.15rem;
        font-weight: 800;
        margin: 0 0 0.5rem;
        color: var(--color-text-main);
    }

    .history-confirm-dialog p {
        margin: 0 0 0.95rem;
        color: var(--color-text-muted);
        font-size: 0.95rem;
        line-height: 1.45;
        max-width: none;
    }

    .history-confirm-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.55rem;
    }

    .history-confirm-btn {
        border-radius: 8px;
        border: 1px solid var(--color-border);
        padding: 0.6rem 0.85rem;
        font-family: var(--font-display);
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    .history-confirm-btn-cancel {
        background: #FFFFFF;
        color: var(--color-text-main);
    }

    .history-confirm-btn-cancel:hover {
        background: var(--color-surface);
    }

    .history-confirm-btn-accept {
        background: #DC2626;
        border-color: #DC2626;
        color: #FFFFFF;
    }

    .history-confirm-btn-accept:hover {
        background: #B91C1C;
        border-color: #B91C1C;
    }

    :global(body.history-confirm-open) {
        overflow: hidden;
    }
</style>

<script>
    import { getHistory, clearHistory } from "../../utils/historyManager";

    const container = document.getElementById("history-container");
    const list = document.getElementById("history-list");
    const clearBtn = document.getElementById("clear-history-btn");
    const confirmOverlay = document.getElementById("history-confirm-overlay");
    const confirmDialog = document.getElementById("history-confirm-dialog");
    const confirmCancel = document.getElementById("history-confirm-cancel");
    const confirmAccept = document.getElementById("history-confirm-accept");
    let confirmResolver = null;
    let previousFocused = null;

    const renderHistory = () => {
        const history = getHistory();
        if (!list) return;

        list.textContent = "";

        if (history.length === 0) {
            container?.classList.add("hidden");
            return;
        }

        container?.classList.remove("hidden");

        const fragment = document.createDocumentFragment();

        for (const item of history) {
            const itemEl = document.createElement("div");
            itemEl.className = "history-item";
            itemEl.dataset.id = item.id;

            const infoEl = document.createElement("div");
            infoEl.className = "history-info";

            const typeEl = document.createElement("span");
            typeEl.className = "history-type";
            typeEl.textContent = item.type;

            const summaryEl = document.createElement("span");
            summaryEl.className = "history-summary";
            summaryEl.textContent = item.summary;

            const resultEl = document.createElement("span");
            resultEl.className = "history-result";
            resultEl.textContent = item.result;

            infoEl.append(typeEl, summaryEl);
            itemEl.append(infoEl, resultEl);
            fragment.appendChild(itemEl);
        }

        list.appendChild(fragment);
    };

    // Initial render
    renderHistory();

    // Listen for updates
    window.addEventListener("history-updated", renderHistory);

    // Handle Item Click (Restore)
    list?.addEventListener("click", (e) => {
        const target = e.target;
        if (!(target instanceof Element)) return;

        const itemEl = target.closest(".history-item");
        if (itemEl) {
            const id = itemEl.getAttribute("data-id");
            const history = getHistory();
            const item = history.find((h) => h.id === id);
            if (item) {
                window.dispatchEvent(
                    new CustomEvent("restore-calc", { detail: item }),
                );
            }
        }
    });

    // Clear handler
    const closeConfirmDialog = (confirmed) => {
        if (!confirmOverlay) return;
        confirmOverlay.classList.add("hidden");
        confirmOverlay.setAttribute("aria-hidden", "true");
        document.body.classList.remove("history-confirm-open");
        if (confirmResolver) {
            confirmResolver(Boolean(confirmed));
            confirmResolver = null;
        }
        if (previousFocused instanceof HTMLElement) {
            previousFocused.focus();
        }
    };

    const openConfirmDialog = () =>
        new Promise((resolve) => {
            if (!confirmOverlay || !confirmDialog) {
                resolve(false);
                return;
            }
            confirmResolver = resolve;
            previousFocused = document.activeElement;
            confirmOverlay.classList.remove("hidden");
            confirmOverlay.setAttribute("aria-hidden", "false");
            document.body.classList.add("history-confirm-open");
            confirmDialog.focus();
        });

    confirmCancel?.addEventListener("click", () => closeConfirmDialog(false));
    confirmAccept?.addEventListener("click", () => closeConfirmDialog(true));

    confirmOverlay?.addEventListener("click", (event) => {
        if (event.target === confirmOverlay) {
            closeConfirmDialog(false);
        }
    });

    document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && confirmOverlay && !confirmOverlay.classList.contains("hidden")) {
            closeConfirmDialog(false);
        }
    });

    clearBtn?.addEventListener("click", async () => {
        const confirmed = await openConfirmDialog();
        if (confirmed) {
            clearHistory();
        }
    });
</script>

