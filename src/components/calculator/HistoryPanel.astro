<div id="history-container" class="history-container hidden">
    <div class="history-header">
        <h3>
            <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><circle cx="12" cy="12" r="10"></circle><polyline
                    points="12 6 12 12 16 14"></polyline></svg
            >
            Recent History
        </h3>
        <button id="clear-history-btn" class="btn-clear">Clear All</button>
    </div>
    <div id="history-list" class="history-list">
        <!-- JS injected -->
    </div>
</div>

<style>
    .history-container {
        background: #fff;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: var(--space-md);
        margin-top: var(--space-lg);
        box-shadow: var(--shadow-sm);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .history-container.hidden {
        display: none;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--color-border);
    }

    .history-header h3 {
        font-size: 1.1rem;
        color: var(--color-text-main);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .btn-clear {
        background: none;
        border: none;
        color: var(--color-text-muted);
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: underline;
    }

    .btn-clear:hover {
        color: #ef4444;
    }

    .history-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    /* Dynamic Item Styles (Global because injected by JS) */
    :global(.history-item) {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--color-surface);
        border-radius: 8px;
        border-left: 3px solid var(--color-primary);
        cursor: pointer;
        transition:
            transform 0.1s ease,
            background-color 0.2s;
    }

    :global(.history-item:hover) {
        background-color: var(--color-surface-hover);
        transform: translateX(2px);
    }

    :global(.history-info) {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    :global(.history-type) {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--color-text-muted);
        letter-spacing: 0.05em;
    }

    :global(.history-summary) {
        font-size: 0.9rem;
        color: var(--color-text-main);
    }

    :global(.history-result) {
        font-weight: 700;
        color: var(--color-primary);
        font-family: var(--font-display);
    }
</style>

<script>
    import { getHistory, clearHistory } from "../../utils/historyManager";

    const container = document.getElementById("history-container");
    const list = document.getElementById("history-list");
    const clearBtn = document.getElementById("clear-history-btn");

    const renderHistory = () => {
        const history = getHistory();

        if (history.length === 0) {
            container?.classList.add("hidden");
            return;
        }

        container?.classList.remove("hidden");
        if (list) {
            list.innerHTML = history
                .map(
                    (item) => `
        <div class="history-item" data-id="${item.id}">
          <div class="history-info">
            <span class="history-type">${item.type}</span>
            <span class="history-summary">${item.summary}</span>
          </div>
          <span class="history-result">${item.result}</span>
        </div>
      `,
                )
                .join("");
        }
    };

    // Initial render
    renderHistory();

    // Listen for updates
    window.addEventListener("history-updated", renderHistory);

    // Handle Item Click (Restore)
    list?.addEventListener("click", (e) => {
        const target = e.target as Element;
        const itemEl = target.closest(".history-item");
        if (itemEl) {
            const id = itemEl.getAttribute("data-id");
            const history = getHistory();
            const item = history.find((h) => h.id === id);
            if (item) {
                window.dispatchEvent(
                    new CustomEvent("restore-calc", { detail: item }),
                );
            }
        }
    });

    // Clear handler
    clearBtn?.addEventListener("click", () => {
        if (
            confirm("Are you sure you want to clear your calculation history?")
        ) {
            clearHistory();
        }
    });
</script>

